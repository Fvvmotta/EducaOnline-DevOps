# ============================================
# GitHub Actions - PR Validation
# ValidaÃ§Ã£o de Pull Requests
# ============================================

name: PR Validation

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  # ==========================================
  # VALIDAÃ‡ÃƒO DE BUILD
  # ==========================================
  validate-build:
    name: Validar Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore de dependÃªncias
        run: dotnet restore backend/EducaOnline.sln

      - name: Build da soluÃ§Ã£o
        run: dotnet build backend/EducaOnline.sln --configuration Release --no-restore

  # ==========================================
  # VALIDAÃ‡ÃƒO DE TESTES
  # ==========================================
  validate-tests:
    name: Validar Testes
    runs-on: ubuntu-latest
    needs: validate-build
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore de dependÃªncias
        run: dotnet restore backend/EducaOnline.sln

      - name: Build da soluÃ§Ã£o
        run: dotnet build backend/EducaOnline.sln --configuration Release --no-restore

      - name: Executar testes
        run: dotnet test backend/EducaOnline.sln --configuration Release --no-build --verbosity normal
        continue-on-error: true

  # ==========================================
  # VALIDAÃ‡ÃƒO DE DOCKERFILES
  # ==========================================
  validate-dockerfiles:
    name: Validar Dockerfiles
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Verificar Dockerfiles existem
        run: |
          echo "Verificando Dockerfiles..."
          ls -la backend/src/services/EducaOnline.Identidade.API/Dockerfile
          ls -la backend/src/services/EducaOnline.Conteudo.API/Dockerfile
          ls -la backend/src/services/EducaOnline.Aluno.API/Dockerfile
          ls -la backend/src/services/EducaOnline.Pedidos.API/Dockerfile
          ls -la backend/src/services/EducaOnline.Financeiro.API/Dockerfile
          ls -la backend/src/api_gateways/EducaOnline.Bff/Dockerfile
          echo "âœ… Todos os Dockerfiles encontrados"

  # ==========================================
  # VALIDAÃ‡ÃƒO DE YAML KUBERNETES
  # ==========================================
  validate-kubernetes:
    name: Validar Manifests K8s
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Verificar manifests existem
        run: |
          echo "Verificando manifests Kubernetes..."
          ls -la k8s/base/
          ls -la k8s/services/
          echo "âœ… Manifests encontrados"

  # ==========================================
  # RESUMO DO PR
  # ==========================================
  pr-summary:
    name: Resumo do PR
    runs-on: ubuntu-latest
    needs: [validate-build, validate-tests, validate-dockerfiles, validate-kubernetes]
    if: always()
    
    steps:
      - name: Criar resumo
        run: |
          echo "## ðŸ“‹ Resumo da ValidaÃ§Ã£o do PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.validate-build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Testes | ${{ needs.validate-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfiles | ${{ needs.validate-dockerfiles.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes | ${{ needs.validate-kubernetes.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
